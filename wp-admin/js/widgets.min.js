var wpWidgets;!function(c){wpWidgets={init:function(){var o,r,d=this,t=c(".widgets-chooser"),s=t.find(".widgets-chooser-sidebars"),e=c("div.widgets-sortables"),l=!("undefined"==typeof isRtl||!isRtl);c("#widgets-right .sidebar-name").click(function(){var e=c(this),t=e.closest(".widgets-holder-wrap");t.hasClass("closed")?(t.removeClass("closed"),e.parent().sortable("refresh")):t.addClass("closed")}),c("#widgets-left .sidebar-name").click(function(){c(this).closest(".widgets-holder-wrap").toggleClass("closed")}),c(document.body).bind("click.widgets-toggle",function(e){var t,i,d,s,n=c(e.target),a={"z-index":100};n.parents(".widget-top").length&&!n.parents("#available-widgets").length?(i=(t=n.closest("div.widget")).children(".widget-inside"),d=parseInt(t.find("input.widget-width").val(),10),s=t.parent().width(),i.is(":hidden")?(250<d&&s<d+30&&t.closest("div.widgets-sortables").length&&(a[t.closest("div.widget-liquid-right").length?l?"margin-right":"margin-left":l?"margin-left":"margin-right"]=s-(d+30)+"px",t.css(a)),t.addClass("open"),i.slideDown("fast")):i.slideUp("fast",function(){t.attr("style",""),t.removeClass("open")}),e.preventDefault()):n.hasClass("widget-control-save")?(wpWidgets.save(n.closest("div.widget"),0,1,0),e.preventDefault()):n.hasClass("widget-control-remove")?(wpWidgets.save(n.closest("div.widget"),1,1,0),e.preventDefault()):n.hasClass("widget-control-close")&&((t=n.closest("div.widget")).removeClass("open"),wpWidgets.close(t),e.preventDefault())}),e.children(".widget").each(function(){var e=c(this);wpWidgets.appendTitle(this),e.find("p.widget-error").length&&e.find("a.widget-action").trigger("click")}),c("#widget-list").children(".widget").draggable({connectToSortable:"div.widgets-sortables",handle:"> .widget-top > .widget-title",distance:2,helper:"clone",zIndex:100,containment:"document",start:function(e,t){var i=c(this).find(".widgets-chooser");t.helper.find("div.widget-description").hide(),r=this.id,i.length&&(c("#wpbody-content").append(i.hide()),t.helper.find(".widgets-chooser").remove(),d.clearWidgetSelection())},stop:function(){o&&c(o).hide(),o=""}}),e.sortable({placeholder:"widget-placeholder",items:"> .widget",handle:"> .widget-top > .widget-title",cursor:"move",distance:2,containment:"document",start:function(e,t){var i=c(this),d=i.parent(),s=t.item.children(".widget-inside");"block"===s.css("display")&&(s.hide(),c(this).sortable("refreshPositions")),d.hasClass("closed")||(t=t.item.hasClass("ui-draggable")?i.height():1+i.height(),i.css("min-height",t+"px"))},stop:function(e,t){var i,d,s,n=t.item,a=r;if(n.hasClass("deleting"))return wpWidgets.save(n,1,0,1),void n.remove();i=n.find("input.add_new").val(),d=n.find("input.multi_number").val(),n.attr("style","").removeClass("ui-draggable"),r="",i&&("multi"===i?(n.html(n.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,d)})),n.attr("id",a.replace("__i__",d)),d++,c("div#"+a).find("input.multi_number").val(d)):"single"===i&&(n.attr("id","new-"+a),o="div#"+a),wpWidgets.save(n,0,0,1),n.find("input.add_new").val(""),c(document).trigger("widget-added",[n])),(s=n.parent()).parent().hasClass("closed")&&(s.parent().removeClass("closed"),1<(t=s.children(".widget")).length&&(a=t.get(0),t=n.get(0),a.id&&t.id&&a.id!==t.id&&c(a).before(n))),i?n.find("a.widget-action").trigger("click"):wpWidgets.saveOrder(s.attr("id"))},activate:function(){c(this).parent().addClass("widget-hover")},deactivate:function(){c(this).css("min-height","").parent().removeClass("widget-hover")},receive:function(e,t){t=c(t.sender);-1<this.id.indexOf("orphaned_widgets")?t.sortable("cancel"):-1<t.attr("id").indexOf("orphaned_widgets")&&!t.children(".widget").length&&t.parents(".orphan-sidebar").slideUp(400,function(){c(this).remove()})}}).sortable("option","connectWith","div.widgets-sortables"),c("#available-widgets").droppable({tolerance:"pointer",accept:function(e){return"widget-list"!==c(e).parent().attr("id")},drop:function(e,t){t.draggable.addClass("deleting"),c("#removing-widget").hide().children("span").html("")},over:function(e,t){t.draggable.addClass("deleting"),c("div.widget-placeholder").hide(),t.draggable.hasClass("ui-sortable-helper")&&c("#removing-widget").show().children("span").html(t.draggable.find("div.widget-title").children("h4").html())},out:function(e,t){t.draggable.removeClass("deleting"),c("div.widget-placeholder").show(),c("#removing-widget").hide().children("span").html("")}}),c("#widgets-right .widgets-holder-wrap").each(function(e,t){var i=c(t),t=i.find(".sidebar-name h3").text(),i=i.find(".widgets-sortables").attr("id"),t=c('<li tabindex="0">').text(c.trim(t));0===e&&t.addClass("widgets-chooser-selected"),s.append(t),t.data("sidebarId",i)}),c("#available-widgets .widget .widget-title").on("click.widgets-chooser",function(){var e=c(this).closest(".widget");e.hasClass("widget-in-question")||c("#widgets-left").hasClass("chooser")?d.closeChooser():(d.clearWidgetSelection(),c("#widgets-left").addClass("chooser"),e.addClass("widget-in-question").children(".widget-description").after(t),t.slideDown(300,function(){s.find(".widgets-chooser-selected").focus()}),s.find("li").on("focusin.widgets-chooser",function(){s.find(".widgets-chooser-selected").removeClass("widgets-chooser-selected"),c(this).addClass("widgets-chooser-selected")}))}),t.on("click.widgets-chooser",function(e){e=c(e.target);e.hasClass("button-primary")?(d.addWidget(t),d.closeChooser()):e.hasClass("button-secondary")&&d.closeChooser()}).on("keyup.widgets-chooser",function(e){e.which===c.ui.keyCode.ENTER?(c(e.target).hasClass("button-secondary")||d.addWidget(t),d.closeChooser()):e.which===c.ui.keyCode.ESCAPE&&d.closeChooser()})},saveOrder:function(e){var t={action:"widgets-order",savewidgets:c("#_wpnonce_widgets").val(),sidebars:[]};e&&c("#"+e).find(".spinner:first").css("display","inline-block"),c("div.widgets-sortables").each(function(){c(this).sortable&&(t["sidebars["+c(this).attr("id")+"]"]=c(this).sortable("toArray").join(","))}),c.post(ajaxurl,t,function(){c(".spinner").hide()})},save:function(i,d,s,n){var e=i.closest("div.widgets-sortables").attr("id"),t=i.find("form").serialize();i=c(i),c(".spinner",i).show(),e={action:"save-widget",savewidgets:c("#_wpnonce_widgets").val(),sidebar:e},d&&(e.delete_widget=1),t+="&"+c.param(e),c.post(ajaxurl,t,function(e){var t;d?(c("input.widget_number",i).val()||(t=c("input.widget-id",i).val(),c("#available-widgets").find("input.widget-id").each(function(){c(this).val()===t&&c(this).closest("div.widget").show()})),s?(n=0,i.slideUp("fast",function(){c(this).remove(),wpWidgets.saveOrder()})):i.remove()):(c(".spinner").hide(),e&&2<e.length&&(c("div.widget-content",i).html(e),wpWidgets.appendTitle(i),c(document).trigger("widget-updated",[i]))),n&&wpWidgets.saveOrder()})},appendTitle:function(e){var t=(t=c('input[id*="-title"]',e).val()||"")&&": "+t.replace(/<[^<>]+>/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;");c(e).children(".widget-top").children(".widget-title").children().children(".in-widget-title").html(t)},close:function(e){e.children(".widget-inside").slideUp("fast",function(){e.attr("style","")})},addWidget:function(e){var t=e.find(".widgets-chooser-selected").data("sidebarId"),i=c("#"+t),d=c("#available-widgets").find(".widget-in-question").clone(),s=d.attr("id"),e=d.find("input.add_new").val(),n=d.find("input.multi_number").val();d.find(".widgets-chooser").remove(),"multi"===e?(d.html(d.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,n)})),d.attr("id",s.replace("__i__",n)),n++,c("#"+s).find("input.multi_number").val(n)):"single"===e&&(d.attr("id","new-"+s),c("#"+s).hide()),i.closest(".widgets-holder-wrap").removeClass("closed"),i.append(d),i.sortable("refresh"),wpWidgets.save(d,0,0,1),d.find("input.add_new").val(""),c(document).trigger("widget-added",[d]),e=(t=c(window).scrollTop())+c(window).height(),(s=i.offset()).bottom=s.top+i.outerHeight(),(t>s.bottom||e<s.top)&&c("html, body").animate({scrollTop:s.top-130},200),window.setTimeout(function(){d.find(".widget-title").trigger("click")},250)},closeChooser:function(){var e=this;c(".widgets-chooser").slideUp(200,function(){c("#wpbody-content").append(this),e.clearWidgetSelection()})},clearWidgetSelection:function(){c("#widgets-left").removeClass("chooser"),c(".widget-in-question").removeClass("widget-in-question")}},c(document).ready(function(){wpWidgets.init()})}(jQuery);