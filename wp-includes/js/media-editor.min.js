!function(a){var r,i={};wp.media.string={props:function(e,t){var i,n=wp.media.view.settings.defaultProps,a=function(e){return"image"!==e.type||e.alt||(e.alt=e.caption||e.title||"",e.alt=e.alt.replace(/<\/?[^>]+>/g,""),e.alt=e.alt.replace(/[\r\n]+/g," ")),e};return e=e?_.clone(e):{},t&&t.type&&(e.type=t.type),"image"===e.type&&(e=_.defaults(e||{},{align:n.align||getUserSetting("align","none"),size:n.size||getUserSetting("imgsize","medium"),url:"",classes:[]})),t&&(e.title=e.title||t.title,"file"===(n=e.link||n.link||getUserSetting("urlbutton","file"))||"embed"===n?i=t.url:"post"===n?i=t.link:"custom"===n&&(i=e.linkUrl),e.linkUrl=i||"","image"===t.type?(e.classes.push("wp-image-"+t.id),i=(i=t.sizes)&&i[e.size]?i[e.size]:t,_.extend(e,_.pick(t,"align","caption","alt"),{width:i.width,height:i.height,src:i.url,captionId:"attachment_"+t.id})):"video"===t.type||"audio"===t.type?_.extend(e,_.pick(t,"title","type","icon","mime")):(e.title=e.title||t.filename,e.rel=e.rel||"attachment wp-att-"+t.id)),a(e)},link:function(e,t){t={tag:"a",content:(e=wp.media.string.props(e,t)).title,attrs:{href:e.linkUrl}};return e.rel&&(t.attrs.rel=e.rel),wp.html.string(t)},audio:function(e,t){return wp.media.string._audioVideo("audio",e,t)},video:function(e,t){return wp.media.string._audioVideo("video",e,t)},_audioVideo:function(e,t,i){var n,a;return"embed"!==(t=wp.media.string.props(t,i)).link?wp.media.string.link(t):(n={},"video"===e&&(i.width&&(n.width=i.width),i.height&&(n.height=i.height)),a=i.filename.split(".").pop(),_.contains(wp.media.view.settings.embedExts,a)?(n[a]=i.url,wp.shortcode.string({tag:e,attrs:n})):wp.media.string.link(t))},image:function(e,t){var i={},n=(e=wp.media.string.props(e,t)).classes||[];return i.src=(void 0!==t?t:e).url,_.extend(i,_.pick(e,"width","height","alt")),e.align&&!e.caption&&n.push("align"+e.align),e.size&&n.push("size-"+e.size),i["class"]=_.compact(n).join(" "),t={tag:"img",attrs:i,single:!0},e.linkUrl&&(t={tag:"a",attrs:{href:e.linkUrl},content:t}),n=wp.html.string(t),e.caption&&(t={},i.width&&(t.width=i.width),e.captionId&&(t.id=e.captionId),e.align&&(t.align="align"+e.align),n=wp.shortcode.string({tag:"caption",attrs:t,content:n+" "+e.caption})),n}},wp.media.gallery=(r={},{defaults:{order:"ASC",id:wp.media.view.settings.post.id,itemtag:"dl",icontag:"dt",captiontag:"dd",columns:"3",link:"post",size:"thumbnail",orderby:"menu_order ID"},attachments:function(e){var t=e.string(),i=r[t];return delete r[t],i||(i=_.defaults(e.attrs.named,wp.media.gallery.defaults),(e=_.pick(i,"orderby","order")).type="image",e.perPage=-1,void 0!==i.orderby&&(i._orderByField=i.orderby),"rand"===i.orderby&&(i._orderbyRandom=!0),i.orderby&&!/^menu_order(?: ID)?$/i.test(i.orderby)||(e.orderby="menuOrder"),i.ids?(e.post__in=i.ids.split(","),e.orderby="post__in"):i.include&&(e.post__in=i.include.split(",")),i.exclude&&(e.post__not_in=i.exclude.split(",")),e.post__in||(e.uploadedTo=i.id),i=_.omit(i,"id","ids","include","exclude","orderby","order"),(e=wp.media.query(e)).gallery=new Backbone.Model(i),e)},shortcode:function(e){var t,i=e.props.toJSON(),n=_.pick(i,"orderby","order");return e.gallery&&_.extend(n,e.gallery.toJSON()),n.ids=e.pluck("id"),i.uploadedTo&&(n.id=i.uploadedTo),delete n.orderby,n._orderbyRandom?n.orderby="rand":n._orderByField&&"rand"!=n._orderByField&&(n.orderby=n._orderByField),delete n._orderbyRandom,delete n._orderByField,n.ids&&"post__in"===n.orderby&&delete n.orderby,_.each(wp.media.gallery.defaults,function(e,t){e===n[t]&&delete n[t]}),t=new wp.shortcode({tag:"gallery",attrs:n,type:"single"}),(i=new wp.media.model.Attachments(e.models,{props:i})).gallery=e.gallery,r[t.string()]=i,t},edit:function(e){var t,i=wp.shortcode.next("gallery",e),n=wp.media.gallery.defaults.id;if(i&&i.content===e)return i=i.shortcode,_.isUndefined(i.get("id"))&&!_.isUndefined(n)&&i.set("id",n),i=wp.media.gallery.attachments(i),(t=new wp.media.model.Selection(i.models,{props:i.props.toJSON(),multiple:!0})).gallery=i.gallery,t.more().done(function(){t.props.set({query:!1}),t.unmirror(),t.props.unset("orderby")}),this.frame&&this.frame.dispose(),this.frame=wp.media({frame:"post",state:"gallery-edit",title:wp.media.view.l10n.editGalleryTitle,editing:!0,multiple:!0,selection:t}).open(),this.frame}}),wp.media.featuredImage={get:function(){return wp.media.view.settings.post.featuredImageId},set:function(e){var t=wp.media.view.settings;t.post.featuredImageId=e,wp.media.post("set-post-thumbnail",{json:!0,post_id:t.post.id,thumbnail_id:t.post.featuredImageId,_wpnonce:t.post.nonce}).done(function(e){a(".inside","#postimagediv").html(e)})},frame:function(){return this._frame||(this._frame=wp.media({state:"featured-image",states:[new wp.media.controller.FeaturedImage]}),this._frame.on("toolbar:create:featured-image",function(e){this.createSelectToolbar(e,{text:wp.media.view.l10n.setFeaturedImage})},this._frame),this._frame.state("featured-image").on("select",this.select),this._frame)},select:function(){var e=wp.media.view.settings,t=this.get("selection").single();e.post.featuredImageId&&wp.media.featuredImage.set(t?t.id:-1)},init:function(){a("#postimagediv").on("click","#set-post-thumbnail",function(e){e.preventDefault(),e.stopPropagation(),wp.media.featuredImage.frame().open()}).on("click","#remove-post-thumbnail",function(){wp.media.view.settings.post.featuredImageId=-1})}},a(wp.media.featuredImage.init),wp.media.editor={insert:function(e){var t,i="undefined"!=typeof tinymce,n="undefined"!=typeof QTags,a=window.wpActiveEditor;if(window.send_to_editor)return window.send_to_editor.apply(this,arguments);if(a)i&&(t=!tinymce.activeEditor||"mce_fullscreen"!=tinymce.activeEditor.id&&"wp_mce_fullscreen"!=tinymce.activeEditor.id?tinymce.get(a):tinymce.activeEditor);else if(i&&tinymce.activeEditor)t=tinymce.activeEditor,a=window.wpActiveEditor=t.id;else if(!n)return!1;if(t&&!t.isHidden()?(tinymce.isIE&&t.windowManager.insertimagebookmark&&t.selection.moveToBookmark(t.windowManager.insertimagebookmark),-1!==e.indexOf("[caption")?t.wpSetImgCaption&&(e=t.wpSetImgCaption(e)):-1!==e.indexOf("[gallery")?t.plugins.wpgallery&&(e=t.plugins.wpgallery._do_gallery(e)):0===e.indexOf("[embed")&&t.plugins.wordpress&&(e=t.plugins.wordpress._setEmbed(e)),t.execCommand("mceInsertContent",!1,e)):n?QTags.insertContent(e):document.getElementById(a).value+=e,window.tb_remove)try{window.tb_remove()}catch(e){}},add:function(e,t){var n=this.get(e);return n||((n=i[e]=wp.media(_.defaults(t||{},{frame:"post",state:"insert",title:wp.media.view.l10n.addMedia,multiple:!0}))).on("insert",function(e){var i=n.state();(e=e||i.get("selection"))&&a.when.apply(a,e.map(function(e){var t=i.display(e).toJSON();return this.send.attachment(t,e.toJSON())},this)).done(function(){wp.media.editor.insert(_.toArray(arguments).join("\n\n"))})},this),n.state("gallery-edit").on("update",function(e){this.insert(wp.media.gallery.shortcode(e).string())},this),n.state("embed").on("select",function(){var e=n.state(),t=e.get("type"),e=e.props.toJSON();e.url=e.url||"","link"===t?(_.defaults(e,{title:e.url,linkUrl:e.url}),this.send.link(e).done(function(e){wp.media.editor.insert(e)})):"image"===t&&(_.defaults(e,{title:e.url,linkUrl:"",align:"none",link:"none"}),"none"===e.link?e.linkUrl="":"file"===e.link&&(e.linkUrl=e.url),this.insert(wp.media.string.image(e)))},this),n.state("featured-image").on("select",wp.media.featuredImage.select),n.setState(n.options.state),n)},id:function(e){return e=e||((e=!(e=wpActiveEditor)&&"undefined"!=typeof tinymce&&tinymce.activeEditor?tinymce.activeEditor.id:e)||"")},get:function(e){return e=this.id(e),i[e]},remove:function(e){e=this.id(e),delete i[e]},send:{attachment:function(i,e){var n,t,a=e.caption;return wp.media.view.settings.captions||delete e.caption,i=wp.media.string.props(i,e),n={id:e.id,post_content:e.description,post_excerpt:a},i.linkUrl&&(n.url=i.linkUrl),"image"===e.type?(t=wp.media.string.image(i),_.each({align:"align",size:"image-size",alt:"image_alt"},function(e,t){i[t]&&(n[e]=i[t])})):"video"===e.type?t=wp.media.string.video(i,e):"audio"===e.type?t=wp.media.string.audio(i,e):(t=wp.media.string.link(i),n.post_title=i.title),wp.media.post("send-attachment-to-editor",{nonce:wp.media.view.settings.nonce.sendToEditor,attachment:n,html:t,post_id:wp.media.view.settings.post.id})},link:function(e){return wp.media.post("send-link-to-editor",{nonce:wp.media.view.settings.nonce.sendToEditor,src:e.linkUrl,title:e.title,html:wp.media.string.link(e),post_id:wp.media.view.settings.post.id})}},open:function(e,t){var i;return t=t||{},e=this.id(e),"undefined"!=typeof tinymce&&(i=tinymce.get(e),tinymce.isIE&&i&&!i.isHidden()&&(i.focus(),i.windowManager.insertimagebookmark=i.selection.getBookmark())),(i=!(i=this.get(e))||i.options&&t.state!==i.options.state?this.add(e,t):i).open()},init:function(){a(document.body).on("click",".insert-media",function(e){var t=a(this),i=t.data("editor"),n={frame:"post",state:"insert",title:wp.media.view.l10n.addMedia,multiple:!0};e.preventDefault(),t.blur(),t.hasClass("gallery")&&(n.state="gallery",n.title=wp.media.view.l10n.createGalleryTitle),wp.media.editor.open(i,n)})}},_.bindAll(wp.media.editor,"open"),a(wp.media.editor.init)}(jQuery);